<html>
	<head>
		<title>js-binarypack UTF-8 Test</title>
		<script src="../dist/binarypack.js"></script>
		<script>
			[
				"hello",
				"café",
				"中文",
				"broccoli🥦līp𨋢grin😃ok",
				"un\ud800paired\udfffsurrogates",
			].forEach(function (text) {
				var expected = text.replace(
					/[\ud800-\udbff](?![\udc00-\udfff])|(?<![\ud800-\udbff])[\udc00-\udfff]/g,
					"\ufffd",
				);
				var packedVal = BinaryPack.pack(text);
				blobToArrayBuffer(packedVal, function (ab) {
					var unpackedVal;
					try {
						unpackedVal = BinaryPack.unpack(ab);
						if (expected === unpackedVal) {
							console.log("pass", JSON.stringify(text));
						} else {
							console.log(
								"fail",
								JSON.stringify(expected),
								JSON.stringify(unpackedVal),
							);
						}
					} catch (err) {
						console.log("error", JSON.stringify(text), err);
					}
				});
			});

			function blobToArrayBuffer(blob, cb) {
				var fr = new FileReader();
				fr.onload = function (evt) {
					cb(evt.target.result);
				};
				fr.readAsArrayBuffer(blob);
			}
		</script>
	</head>
	<body>
		<h2>Test binarypack UTF-8 correctness</h2>
		Results are shown in the Javascript console
	</body>
</html>
